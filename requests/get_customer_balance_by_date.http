### Buscar saldo calculado com agregações nativas (performático)
GET http://localhost:9200/ciclo_vida_recebivel/_search?pretty=
Content-Type: application/json

{
  "size": 0,
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "codigo_cliente.keyword": "123456"
          }
        },
        {
          "range": {
            "data_vencimento": {
              "gte": "2025-01-01",
              "lte": "2026-12-31"
            }
          }
        }
      ]
    }
  },
  "aggs": {
    "resultado": {
      "filters": {
        "filters": {
          "all": {
            "match_all": {}
          }
        }
      },
      "aggs": {
        "soma_valores_originais": {
          "sum": {
            "field": "valor_original"
          }
        },
        "soma_cancelamentos": {
          "nested": {
            "path": "cancelamentos"
          },
          "aggs": {
            "total_cancelado": {
              "sum": {
                "field": "cancelamentos.valor_cancelado"
              }
            }
          }
        },
        "soma_negociacoes": {
          "nested": {
            "path": "negociacoes"
          },
          "aggs": {
            "total_negociado": {
              "sum": {
                "field": "negociacoes.valor_negociado"
              }
            }
          }
        },
        "saldo_disponivel": {
          "bucket_script": {
            "buckets_path": {
              "valores": "soma_valores_originais",
              "cancelamentos": "soma_cancelamentos>total_cancelado",
              "negociacoes": "soma_negociacoes>total_negociado"
            },
            "script": "Math.round((params.valores - params.cancelamentos - params.negociacoes) * 100) / 100"
          }
        }
      }
    }
  }
}
