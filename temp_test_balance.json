{
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "codigo_cliente.keyword": "CLI-10001"
          }
        },
        {
          "script": {
            "script": {
              "lang": "painless",
              "source": "double saldo = doc['valor_original'].value; if (params._source.cancelamentos != null) { for (def c : params._source.cancelamentos) { saldo -= c.valor_cancelado; } } if (params._source.negociacoes != null) { for (def n : params._source.negociacoes) { saldo -= n.valor_negociado; } } return Math.round(saldo * 100.0) / 100.0 >= params.valor_minimo;",
              "params": {
                "valor_minimo": 500.00
              }
            }
          }
        }
      ]
    }
  },
  "script_fields": {
    "saldo_disponivel": {
      "script": {
        "lang": "painless",
        "source": "double saldo = doc['valor_original'].value; if (params._source.cancelamentos != null) { for (def c : params._source.cancelamentos) { saldo -= c.valor_cancelado; } } if (params._source.negociacoes != null) { for (def n : params._source.negociacoes) { saldo -= n.valor_negociado; } } return Math.round(saldo * 100.0) / 100.0;"
      }
    }
  },
  "sort": [
    {
      "_script": {
        "type": "number",
        "script": {
          "lang": "painless",
          "source": "double saldo = doc['valor_original'].value; if (params._source.cancelamentos != null) { for (def c : params._source.cancelamentos) { saldo -= c.valor_cancelado; } } if (params._source.negociacoes != null) { for (def n : params._source.negociacoes) { saldo -= n.valor_negociado; } } return Math.round(saldo * 100.0) / 100.0;"
        },
        "order": "desc"
      }
    }
  ],
  "from": 0,
  "size": 10
}
